services:
  airflow-init:
    image: apache/airflow:2.10.4
    environment:
      AIRFLOW_HOME: /opt/airflow
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@supabase-db:5432/airflow
      AIRFLOW__API__AUTH_BACKENDS: "airflow.api.auth.backend.basic_auth"
      AIRFLOW_ADMIN_USERNAME: ${AIRFLOW_ADMIN_USERNAME}
      AIRFLOW_ADMIN_PASSWORD: ${AIRFLOW_ADMIN_PASSWORD}
      AIRFLOW_ADMIN_EMAIL: ${AIRFLOW_ADMIN_EMAIL}
    entrypoint: ["/bin/bash", "/opt/airflow/init.sh"]
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/data:/opt/airflow/data
      - ./airflow/airflow.cfg:/opt/airflow/airflow.cfg
      - shared-data:/shared_data
      - ./airflow/init.sh:/opt/airflow/init.sh
    networks:
      - supabase_default

  airflow-webserver:
    build: ./airflow
    restart: on-failure
    depends_on:
      - airflow-init
    ports:
      - "8080:8080"
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@supabase-db:5432/airflow
      AIRFLOW__WEBSERVER__RBAC: "True"
      PYTHONWARNINGS: ignore
      AIRFLOW__CORE__DAG_DIR_LIST_INTERVAL: 10
      SUPABASE_PUBLIC_URL: ${SUPABASE_PUBLIC_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
    command: ["webserver"]
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/data:/opt/airflow/data
      - ./airflow/airflow.cfg:/opt/airflow/airflow.cfg
      - shared-data:/shared_data
    networks:
      - supabase_default

  airflow-scheduler:
    build: ./airflow
    restart: on-failure
    depends_on:
      - airflow-webserver
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__DATABASE__SQL_ALCHEMY_CONN: postgresql+psycopg2://airflow:airflow@supabase-db:5432/airflow
      AIRFLOW__CORE__IS_PAUSED_UPON_CREATION: False
      AIRFLOW__CORE__DAG_DIR_LIST_INTERVAL: 10
      SUPABASE_PUBLIC_URL: ${SUPABASE_PUBLIC_URL}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
    command: ["scheduler"]
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/data:/opt/airflow/data
      - ./airflow/airflow.cfg:/opt/airflow/airflow.cfg
      - shared-data:/shared_data
    networks:
      - supabase_default

  fastapi:
    build:
      context: ./backend/api
      dockerfile: Dockerfile
    environment:
      SUPABASE_PUBLIC_URL: ${SUPABASE_PUBLIC_URL}
      SUPABASE_KEY: ${SUPABASE_KEY}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      FRONTEND_URL: ${FRONTEND_URL}
      AIRFLOW_API_URL: ${AIRFLOW_API_URL}
      AIRFLOW_ADMIN_USERNAME: ${AIRFLOW_ADMIN_USERNAME}
      AIRFLOW_ADMIN_PASSWORD: ${AIRFLOW_ADMIN_PASSWORD}
      AIRFLOW_USERNAME: ${AIRFLOW_USERNAME}
      AIRFLOW_PASSWORD: ${AIRFLOW_PASSWORD}
    ports:
      - "8000:8000"
    volumes:
      - ./backend/api:/app
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/data:/opt/airflow/data
      - shared-data:/shared_data
    networks:
      - supabase_default

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      NEXT_PUBLIC_SUPABASE_URL: ${NEXT_PUBLIC_SUPABASE_URL}
      NEXT_PUBLIC_SUPABASE_ANON_KEY: ${NEXT_PUBLIC_SUPABASE_ANON_KEY}
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - shared-data:/shared_data
    depends_on:
      - fastapi
    networks:
      - supabase_default

volumes:
  shared-data:

networks:
  supabase_default:
    external: true