services:
  airflow-init:
    image: apache/airflow:2.10.4
    env_file: .env
    environment:
      AIRFLOW_HOME: /opt/airflow
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__API__AUTH_BACKENDS: "airflow.api.auth.backend.basic_auth"
    entrypoint: ["/bin/bash", "/opt/airflow/init.sh"]
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/data:/opt/airflow/data
      - ./airflow/airflow.cfg:/opt/airflow/airflow.cfg
      - shared-data:/shared_data
      - ./airflow/init.sh:/opt/airflow/init.sh
    networks:
      - supabase_default

  airflow-webserver:
    build: ./airflow
    restart: on-failure
    depends_on:
      - airflow-init
    ports:
      - "8080:8080"
    env_file: .env
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__WEBSERVER__RBAC: "True"
      PYTHONWARNINGS: ignore
      AIRFLOW__CORE__DAG_DIR_LIST_INTERVAL: 10
    command: ["webserver"]
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/data:/opt/airflow/data
      - ./airflow/airflow.cfg:/opt/airflow/airflow.cfg
      - shared-data:/shared_data
    networks:
      - supabase_default

  airflow-scheduler:
    build: ./airflow
    restart: on-failure
    depends_on:
      - airflow-webserver
    env_file: .env
    environment:
      AIRFLOW__CORE__EXECUTOR: LocalExecutor
      AIRFLOW__CORE__IS_PAUSED_UPON_CREATION: False
      AIRFLOW__CORE__DAG_DIR_LIST_INTERVAL: 10
    command: ["scheduler"]
    volumes:
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/data:/opt/airflow/data
      - ./airflow/airflow.cfg:/opt/airflow/airflow.cfg
      - shared-data:/shared_data
    networks:
      - supabase_default

  fastapi:
    build:
      context: ./backend/api
      dockerfile: Dockerfile
    ports:
      - "8000:8000"
    env_file: .env
    volumes:
      - ./backend/api:/app
      - ./airflow/dags:/opt/airflow/dags
      - ./airflow/data:/opt/airflow/data
      - shared-data:/shared_data
    networks:
      - supabase_default

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    volumes:
      - ./frontend:/app
      - /app/node_modules
      - shared-data:/shared_data
    env_file: .env
    depends_on:
      - fastapi
    networks:
      - supabase_default

volumes:
  shared-data:

networks:
  supabase_default:
    external: true